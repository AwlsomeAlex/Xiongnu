#!/bin/busybox sh
##################
# -------------- #
# Xiongnu - Init #
# -------------- #
##################
# System Init Script
####################################
# Copyright (C) 2018 Alex Barris - All Rights Reserved
# Awlsome Public License v1.0
# v1.2.4a

dmesg -n 1 # Supress Kernel Messages
. /lib/libstar/sys.lib
. /lib/libstar/common.lib

# ----- Functions ----- #

# rescueShell [reason]: Drops user into an Emergency Shell
function rescueShell() {
	REASON=$1
	common_print "System could not be initialized! $REASON" -s FAIL
	common_print "Dropping to an Emergency Shell!" -c Red
	xiongnu_welcome
	exec sh -
}

# moveMount [mount point]: Moves mounted directory from InitramFS to realFS
function moveMount() {
	NAME=$1
	mount --move /$NAME /mnt/root/$NAME || rescueShell "Could not move mounted directory $NAME to real Filesystem!"
}

# ----- Init ----- #
common_print "Xiongnu 1.2.4a - StarLinux Build $STARLINUX_BUILD" -c Yellow
common_print "Mounting System Directories...." -s ....
mount -t devtmpfs none /dev || rescueShell "Failed to mount /dev!" 
mount -t proc none /proc || rescueShell "Failed to mount /proc!"
mount -t sysfs none /sys || rescueShell "Failed to mount /sys!"
mount -t tmpfs none /tmp || rescueShell "Fauled to mount /tmp!"
common_print "Mounted System Directories!" -s DONE
common_print "Populating Dynamic Device Directory (/dev)...." -s ....
echo /sbin/mdev > /proc/sys/kernel/hotplug || rescueShell "Failed to call hotplug!"
common_print "Populated Dynamic Device Directory (/dev)!" -s DONE
common_print "Mounting Root Filesystem...." -s ....
mount -a || rescueShell "Failed to Mount Directories from /etc/fstab" # EXPERIMENTAL
# mount -o rw /dev/sda1 /mnt/root || rescueShell "Failed to mount Root Directory!" # /etc/fstab with mount -a would be cool!
common_print "Mounted Root Filesystem!" -s DONE
common_print "Moving System Directories to Root Filesystem...." -s ....
moveMount dev
moveMount sys
moveMount proc
moveMount tmp
common_print "Moved System Directories to Root Filesystem!" -s DONE
common_print "Switching to Root Filesystem...." -s ....
exec switch_root /mnt/root /sbin/init || rescueShell "Failed to switch_root to Root Filesystem!"
